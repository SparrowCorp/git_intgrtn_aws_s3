### Introduction
Integrates 3rd party git providers (Github, Bitbucket, GitHub Enterprise or GitLab) with AWS S3, and deploy via CodeDeploy or CodePipeline.

### Architectural Overview
![Architectural diagram](https://github.com/droidlabour/git_intgrtn_aws_s3/raw/master/cloudcraft.png)
1. `git_intgrtn_aws_s3_main.json`: Integrate 3rd party git providers with AWS S3.
Webhooks notify a remote service by issuing an HTTP POST when a commit is pushed to the repository. [AWS Lambda](http://aws.amazon.com/lambda) receives the HTTP POST through [Amazon API Gateway](https://aws.amazon.com/api-gateway), and then downloads a copy of the repository. It places a zipped copy of the repository into a versioned S3 bucket. [AWS CodePipeline](http://aws.amazon.com/codepipeline) can then use the zip file in S3 as a source; the pipeline will be triggered whenever the Git repository is updated.

There are two methods you can use to get the contents of a repository. Each method exposes Lambda functions that have different security and scalability properties.

- **Zip download** uses the Git provider's HTTP API to download an already-zipped copy of the current state of the repository.
    - No need for external libraries.
    - Smaller Lambda function code.
    - Large repo size limit (500 MB).

- **Git pull** uses SSH to pull from the repository. The repository contents are then zipped and uploaded to S3.
    - Efficient for repositories with a high volume of commits, because each time the API is triggered, it downloads only the changed files.
    - Suitable for any Git server that supports hooks and SSH; does not depend on personal access tokens or OAuth2.
    - More extensible because it uses a standard Git library.
2. `codedeploy_main.json`: Integrate AWS CodeDeploy with AWS S3
    * Multi-AZ, load balanced and auto scaled (CPU Utilization) pre-installed with **CodeDeploy Agent**, **Docker** and **docker-compose**.
    * AWS CodeDeploy Application and DeploymentGroup.
    * Trigger CodeDeploy on `s3:ObjectCreated:*`
3. `ecs_main.json`: 
    * ECS Cluster
    * ECR Repository
    * ECS Service and Task Definition
    * CodePipeline with CodeBuild and Deployment using Cloudformation

#### Note
**Deployment via CodePipeline works only under AWS ECS**
**Deployment via CodeDeploy will work irrespective of Docker as long as the repo contains `appspec.yml`**

### PreRequisites
* ACM verified certificate
* EC2 KeyPair
* IAM user attached with Administrator policy
* Repository hosted in Github/Bitbucket/GitHub Enterprise or GitLab
* DNS NS records hosted in Route53

### Installation (via AWS Cloudformation)
1. `git_intgrtn_aws_s3_main.json`

**OutputBucketName:** The name of the bucket where your zipped code will be uploaded. CloudFormation will create a bucket with this name. For this reason, you cannot use the name of an existing S3 bucket.

**AllowedIps:** Used only with the git pull method described earlier. A comma-separated list of IP CIDR blocks used for Git provider source IP authentication. The Bitbucket Cloud IP ranges are provided as defaults.

**ApiSecret:** Used only with the git pull method described earlier. This parameter is used for webhook secrets in GitHub Enterprise and GitLab. If a secret is matched, IP range authentication is bypassed. The secret cannot contain commas `,`, slashes `\`, or quotation marks `"`.

**GitToken:** Used only with the zip download method described earlier. This is a personal access token generated by GitHub Enterprise or GitLab.

**OauthKey/OuathSecret:** Used only with the zip download method described earlier. This is an OAuth2 key and secret provided by Bitbucket.

    At least one parameter for your chosen method and provider must be set.
    The process for setting up webhook secrets and API tokens differs between vendors and product versions. Consult your Git provider's documentation for details.
    
    After the CloudFormation stack creation is complete, make a note of the `GitPullWebHookApi`, `ZipDownloadWebHookApi`, `OutputBucketName` and `PublicSSHKey`. You will need these in the following steps.

    #### Configure the source repository
    Depending on the method (git pull or zip download) you would like to use, in your Git provider's interface, set the destination URL of your webhook to either the `GitPullWebHookApi` or `ZipDownloadWebHookApi`.

    If you are using the git pull method, the Git repo is downloaded over SSH. For this reason, the PublicSSHKey output must be imported into Git as a deployment key.

    Add `ZipDownloadWebHookApi` or `GitPullWebHookApi` from Cloudformation output section into the repository Webhook settings
And yes you can the URL to multiple repositories.
Repo zipped will be stored in `OutputBucketName/<git-user-name>/<git-repo-name>/<branch-name>/<git-repo-name>.zip`

    #### Test a commit
    After you have set up webhooks on your repository, run the `git push` command to create a folder structure and zip file in the S3 bucket listed in your CloudFormation output as `OutputBucketName`.

2. Skip to `#3` if you want to deploy using CodePipeline instead of CodeDeploy `codedeploy_main.json`:

**ACMARN:** AWS Certificate Manager ARN to be used by Elastic Load Balancer for SSL traffic

**Application:** Application Name

**Environment:** Environment Name

**HealthCheckPort:** Elastic Load Balancer Health Check Port

**InstanceType:** EC2 instance type

**KeyName:** The EC2 Key Pair to allow SSH access to the instances

**RepoBucket:** The name of the bucket where your zipped code will be uploaded, Provide `OutputBucketName` value from Step `#1` Cloudformation Output

**RepoZipPath:** Path to the zipped code in the following format.
`<git-user>/<git-repo-name>/<git-branch-name>/<git-repo-name>.zip`
Example: For https://github.com/droidlabour/git_intgrtn_aws_s3 `RepoZipPath` will be `droidlabour/git_intgrtn_aws_s3/master/git_intgrtn_aws_s3.zip`

3. `ecs_main.json`:

**ACMARN:** AWS Certificate Manager ARN to be used by Elastic Load Balancer for SSL traffic

**Application:** Application Name

**ContainerInstanceKeyPair:** The EC2 Key Pair to allow SSH access to the instances

**ContainerInstanceType:** EC2 instance type

**ContainerPort:** Container port which is exposed

**DesiredCapacity:** No of Container Instances

**ECRImageTag:** Docker image tag, keep it as default `latest`

**ECSTaskDesiredCount:** No of Task, keep it as default `0`

**Environment:** Environment Name

**MinCapacity:** Minimum No of Task, keep it as default `0`

**S3Bucket:** The name of the bucket where your zipped code will be uploaded, Provide `OutputBucketName` value from Step `#1` Cloudformation Output

**S3ObjectLocation:** Path to the zipped code in the following format.
`<git-user>/<git-repo-name>/<git-branch-name>/<git-repo-name>.zip`
Example: For https://github.com/droidlabour/git_intgrtn_aws_s3 `RepoZipPath` will be `droidlabour/git_intgrtn_aws_s3/master/git_intgrtn_aws_s3.zip`

**Subnets:** List of VPC Subnets

**VPC:** VPC ID
4. Use `DNS name` as Alias Record to bind your domain DNS in Route53.

### Contributing
While creating zip Lambda package, make sure to not provide the parent dir
For CreateSSHKey it will be `cd CreateSSHKey && zip -r ../CreateSSHKey.zip .`
